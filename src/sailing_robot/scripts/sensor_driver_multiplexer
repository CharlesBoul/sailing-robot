#!/usr/bin/env python
"""
Node looks up correct sail setting from table
Subscribes: wind direction apparent
Sets sail actuator to correct PWM value
"""
import rospy
from std_msgs.msg import Bool
import pigpio

# GPIO 22/RPi PIN 15 as multiplexer connection
GPIO = rospy.get_param('multiplexer/gpio', default=22)

last_tick = 0
last_interval = 0

def tick(gpio, level, tick):
    global last_tick
    last_tick = tick

def tock(gpio, level, tick):
    global last_interval
    last_interval = tick - last_tick

if __name__ == '__main__':
    pi = pigpio.pi();
    pi.set_mode(GPIO, pigpio.INPUT)
    try:
        pub = rospy.Publisher('remote_control', Bool, queue_size=10)
        rate = rospy.Rate(rospy.get_param("config/rate"))

        pi.callback(GPIO, pigpio.RISING_EDGE, tick)
        pi.callback(GPIO, pigpio.FALLING_EDGE, tock)

        while True:
            pub.publish(last_interval > 1500)
            rate.sleep()

    except rospy.ROSInterruptException:
        pass
